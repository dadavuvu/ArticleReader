name: Build Android
run-name: Creating Production Ready Android App ğŸš€
on:
  push:
    branches:
      - main

permissions:
  contents: write # Release ìƒì„±ì„ ìœ„í•´ ì“°ê¸° ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    
    # ì»¤ë°‹ ë©”ì‹œì§€ê°€ 'Build' ë˜ëŠ” 'Release'ë¡œ ì‹œì‘í•  ë•Œë§Œ ì‘ì—… ì‹¤í–‰
    if: startsWith(github.event.head_commit.message, 'Build') || startsWith(github.event.head_commit.message, 'Release')

    steps:
      - name: Checkout source
        uses: actions/checkout@v3
        with:
          ref: main

      - name: Setup java
        uses: actions/setup-java@v3
        with:
          distribution: "zulu"
          java-version: "11"

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 19.x

      - name: Install dependencies
        run: npm ci

      - name: Create Web Build
        run: npm run build

      - name: Capacitor Sync
        run: |
          if [ ! -d "./android" ]; then npx cap add android; fi
          npx cap update
          npx cap copy

      - name: Generate Assets (Icons/Splash)
        run: |
          if [ -d "./resources" ]; then 
            npm install @capacitor/assets --save-dev
            npx capacitor-assets generate --android
          fi

      # 1. AAB ëŒ€ì‹  APK ìƒì„± (Releaseìš© Unsigned APK ì¶”ì¶œ)
      - name: Build Release APK
        run: cd android && ./gradlew assembleRelease

      # 2. Keystore ë³µí˜¸í™”
      - name: Extract Android signing key from env
        run: |
          echo "${{ secrets.RELEASE_KEYSTORE }}" > android/release.jks.base64
          base64 -d android/release.jks.base64 > android/release.decrypted.jks

      # 3. APK ì„œëª… ì‘ì—…
      - name: Sign Release APK
        run: |
          jarsigner -keystore android/release.decrypted.jks \
            -storepass "${{ secrets.RELEASE_KEYSTORE_PASSWORD }}" \
            -signedjar ./android/app/build/outputs/apk/release/app-release-signed.apk \
            ./android/app/build/outputs/apk/release/app-release-unsigned.apk release

      # 4. ì»¤ë°‹ ë©”ì‹œì§€ íŒŒì‹± (íƒœê·¸ ë° ë¦´ë¦¬ìŠ¤ ì œëª© ê²°ì •)
      - name: Parse Commit Message
        id: parse_msg
        run: |
          SUBJECT=$(echo "${{ github.event.head_commit.message }}" | head -n 1)
          CLEAN_TAG=$(echo "$SUBJECT" | sed -E 's/^(Build|Release)//i' | xargs)
          
          # íƒœê·¸ê°€ ì—†ìœ¼ë©´ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ëŒ€ì²´
          if [ -z "$CLEAN_TAG" ]; then
            CLEAN_TAG="v$(date +'%Y.%m.%d-%H%M')"
          fi

          if [[ "$SUBJECT" =~ ^Release ]]; then
            echo "IS_PRERELEASE=false" >> $GITHUB_OUTPUT
          else
            echo "IS_PRERELEASE=true" >> $GITHUB_OUTPUT
          fi
          
          echo "TAG_NAME=$CLEAN_TAG" >> $GITHUB_OUTPUT
          echo "RELEASE_TITLE=$SUBJECT" >> $GITHUB_OUTPUT

      # 5. GitHub Release ìƒì„± ë° ì„œëª…ëœ APK ì—…ë¡œë“œ
      - name: Create Release and Upload
        uses: softprops/action-gh-release@v2
        with:
          files: |
            android/app/build/outputs/apk/release/app-release-signed.apk
          tag_name: ${{ steps.parse_msg.outputs.TAG_NAME }}
          name: ${{ steps.parse_msg.outputs.RELEASE_TITLE }}
          prerelease: ${{ steps.parse_msg.outputs.IS_PRERELEASE }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}