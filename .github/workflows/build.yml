name: Auto Build

on:
  push:
    branches:
      - main

jobs:
  build:
    if: startsWith(github.event.head_commit.message, 'Build') || startsWith(github.event.head_commit.message, 'Release')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse Commit Message
        id: parse_msg
        run: |
          SUBJECT=$(echo "${{ github.event.head_commit.message }}" | head -n 1)
          CLEAN_TAG=$(echo "$SUBJECT" | sed -E 's/^(Build|Release)//i' | xargs)
          
          if [[ "$SUBJECT" =~ ^Release ]]; then
            echo "IS_PRERELEASE=false" >> $GITHUB_OUTPUT
          else
            echo "IS_PRERELEASE=true" >> $GITHUB_OUTPUT
          fi
          echo "TAG_NAME=$CLEAN_TAG" >> $GITHUB_OUTPUT
          echo "RELEASE_TITLE=$SUBJECT" >> $GITHUB_OUTPUT

      # Keystore 파일 생성 (액션 실행 전 필요)
      - name: Decode Keystore
        run: |
          mkdir -p android/app
          echo "${{ secrets.KEYSTORE }}" | base64 --decode > android/app/release.keystore

      # Capacitor Android Action 사용
      - name: Capacitor Android Build
        uses: nag763/capacitor-android-action@v2.0.0
        with:
          # 웹 빌드 명령어 (예: npm run build)
          build-command: npm run build
          # gradlew가 있는 위치
          android-path: android
          # 빌드 타입 (우리는 직접 서명하므로 assembleRelease 실행)
          args: assembleRelease
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: Create Release and Upload APK
        uses: softprops/action-gh-release@v2
        with:
          files: android/app/build/outputs/apk/release/app-release.apk
          tag_name: ${{ steps.parse_msg.outputs.TAG_NAME }}
          name: ${{ steps.parse_msg.outputs.RELEASE_TITLE }}
          prerelease: ${{ steps.parse_msg.outputs.IS_PRERELEASE }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}