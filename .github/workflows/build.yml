name: Build Android
on:
  push:
    branches:
      - main

permissions:
  contents: write # Release 생성을 위해 쓰기 권한이 필요합니다.

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    
    # 커밋 메시지가 'Build' 또는 'Release'로 시작할 때만 작업 실행
    if: startsWith(github.event.head_commit.message, 'Build') || startsWith(github.event.head_commit.message, 'Release')

    steps:
      - name: Checkout source
        uses: actions/checkout@v3
        with:
          ref: main

      - name: Setup java
        uses: actions/setup-java@v3
        with:
          distribution: "zulu"
          java-version: "11"

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 22.x

      - name: Install dependencies
        run: npm ci

      - name: Create Web Build
        run: npm run build

      - name: Capacitor Sync
        run: |
          npx cap sync android
          if [ ! -d "./android" ]; then npx cap add android; fi
          npx cap update
          npx cap copy

      - name: Generate Assets (Icons/Splash)
        run: |
          if [ -d "./resources" ]; then 
            npm install @capacitor/assets --save-dev
            npx capacitor-assets generate --android
          fi

      # 1. AAB 대신 APK 생성 (Release용 Unsigned APK 추출)
      - name: Build Release APK
        run: cd android && ./gradlew assembleRelease

      # 2. Keystore 복호화
      - name: Extract Android signing key from env
        run: |
          echo "${{ secrets.RELEASE_KEYSTORE }}" > android/release.jks.base64
          base64 -d android/release.jks.base64 > android/release.decrypted.jks

      # 3. APK 서명 작업
      - name: Sign Release APK
        run: |
          jarsigner -keystore android/release.decrypted.jks \
            -storepass "${{ secrets.RELEASE_KEYSTORE_PASSWORD }}" \
            -signedjar ./android/app/build/outputs/apk/release/app-release-signed.apk \
            ./android/app/build/outputs/apk/release/app-release-unsigned.apk release

      # 4. 커밋 메시지 파싱 (태그 및 릴리스 제목 결정)
      - name: Parse Commit Message
        id: parse_msg
        run: |
          SUBJECT=$(echo "${{ github.event.head_commit.message }}" | head -n 1)
          CLEAN_TAG=$(echo "$SUBJECT" | sed -E 's/^(Build|Release)//i' | xargs)
          
          # 태그가 없으면 현재 시간으로 대체
          if [ -z "$CLEAN_TAG" ]; then
            CLEAN_TAG="v$(date +'%Y.%m.%d-%H%M')"
          fi

          if [[ "$SUBJECT" =~ ^Release ]]; then
            echo "IS_PRERELEASE=false" >> $GITHUB_OUTPUT
          else
            echo "IS_PRERELEASE=true" >> $GITHUB_OUTPUT
          fi
          
          echo "TAG_NAME=$CLEAN_TAG" >> $GITHUB_OUTPUT
          echo "RELEASE_TITLE=$SUBJECT" >> $GITHUB_OUTPUT

      # 5. GitHub Release 생성 및 서명된 APK 업로드
      - name: Create Release and Upload
        uses: softprops/action-gh-release@v2
        with:
          files: |
            android/app/build/outputs/apk/release/app-release-signed.apk
          tag_name: ${{ steps.parse_msg.outputs.TAG_NAME }}
          name: ${{ steps.parse_msg.outputs.RELEASE_TITLE }}
          prerelease: ${{ steps.parse_msg.outputs.IS_PRERELEASE }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}