name: Auto Build

on:
  push:
    branches:
      - main # 또는 사용 중인 메인 브랜치명

jobs:
  build:
    # 커밋 메시지 첫 줄이 Build 또는 Release로 시작하는 경우에만 실행
    if: startsWith(github.event.head_commit.message, 'Build') || startsWith(github.event.head_commit.message, 'Release')
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./android 

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse Commit Message and Set Type
        id: parse_msg
        run: |
          FULL_MSG="${{ github.event.head_commit.message }}"
          SUBJECT=$(echo "$FULL_MSG" | head -n 1)
          
          # 1. 태그 이름 추출 (Build 또는 Release 단어 및 뒤의 공백 제거)
          # 예: Build v1.0.0 -> v1.0.0
          CLEAN_TAG=$(echo "$SUBJECT" | sed -E 's/^(Build|Release)//i' | xargs)
          
          # 2. 프리릴리즈 여부 결정 (Release로 시작하면 false, 그 외(Build)는 true)
          if [[ "$SUBJECT" =~ ^Release ]]; then
            echo "IS_PRERELEASE=false" >> $GITHUB_OUTPUT
          else
            echo "IS_PRERELEASE=true" >> $GITHUB_OUTPUT
          fi
          
          echo "TAG_NAME=$CLEAN_TAG" >> $GITHUB_OUTPUT
          echo "RELEASE_TITLE=$SUBJECT" >> $GITHUB_OUTPUT
        working-directory: .

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Decode Keystore
        run: |
          echo "${{ secrets.KEYSTORE }}" | tr -d '\n ' | base64 --decode > app/release.keystore

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Release APK
        run: ./gradlew assembleRelease
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: Create Release and Upload APK
        uses: softprops/action-gh-release@v2
        with:
          files: android/app/build/outputs/apk/release/app-release.apk
          tag_name: ${{ steps.parse_msg.outputs.TAG_NAME }}
          name: ${{ steps.parse_msg.outputs.RELEASE_TITLE }}
          # 파싱된 결과에 따라 결정 (Release -> false, Build -> true)
          prerelease: ${{ steps.parse_msg.outputs.IS_PRERELEASE }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}